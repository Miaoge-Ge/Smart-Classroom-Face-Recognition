{% extends "base.html" %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">系统设置</h1>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">模型配置</h6>
            </div>
            <div class="card-body">
                {% if request.query_params.get('success') %}
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    设置已更新，模型服务正在后台重启...
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endif %}

                <form action="/api/settings" method="post">
                    <div class="mb-4">
                        <label class="form-label font-weight-bold">人脸检测模型 (Face Detection)</label>
                        <select class="form-select" name="det_model">
                            {% for m in det_models %}
                            {% set is_selected = m in config.detector.model_path %}
                            <option value="{{ m }}" {% if is_selected %}selected{% endif %}>{{ m }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">负责在图像中定位人脸位置 (YOLOv8/v11 Pose models)</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label font-weight-bold">人脸识别模型 (Face Recognition)</label>
                        <select class="form-select" name="rec_model">
                            {% for m in rec_models %}
                            {% set is_selected = m in config.recognition.weights_path %}
                            <option value="{{ m }}" {% if is_selected %}selected{% endif %}>{{ m }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">负责提取人脸特征并进行比对 (AdaFace/ArcFace/CosFace)</small>
                    </div>

                    <div class="mb-4">
                        <label class="form-label font-weight-bold">相似度阈值 (Threshold)</label>
                        <input type="number" step="0.01" min="0.1" max="1.0" class="form-control" name="similarity_threshold" value="{{ config.recognition.similarity_threshold }}">
                        <small class="text-muted">判定为同一人的最低分数 (建议: 0.3 - 0.6)</small>
                    </div>

                    <hr>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save fa-sm text-white-50"></i> 保存并应用
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-info">说明</h6>
            </div>
            <div class="card-body">
                <p>更改模型配置后，系统会自动重新加载 AI 引擎，这可能需要几秒钟时间。</p>
                <p>在此期间，人脸识别功能可能会短暂不可用。</p>
                <hr>
                <strong>推荐组合:</strong>
                <ul>
                    <li>检测: <code>yolo11n-pose.pt</code> (速度快)</li>
                    <li>识别: <code>ArcFace/best.pth</code> (准确度高)</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
