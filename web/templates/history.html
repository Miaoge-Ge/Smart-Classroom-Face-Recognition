{% extends "base.html" %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">考勤记录</h2>
    <div class="d-flex gap-2">
        <a class="btn btn-success" href="/api/export_attendance?{% if current_course_id %}course_id={{ current_course_id }}&{% endif %}{% if current_college %}college={{ current_college }}&{% endif %}{% if current_search %}search_query={{ current_search }}&{% endif %}{% if current_start_date %}start_date={{ current_start_date }}&{% endif %}{% if current_end_date %}end_date={{ current_end_date }}&{% endif %}">
            导出 Excel
        </a>
        <button class="btn btn-outline-secondary" type="button" id="printHistoryBtn">打印报表</button>
        <button class="btn btn-danger" type="submit" form="attendanceDeleteForm" id="deleteSelectedAttendanceBtn">删除所选</button>
    </div>
</div>

<div class="card shadow mb-3">
    <div class="card-body">
        <form class="row g-2 align-items-end" method="get" action="/history">
            <div class="col-md-2">
                <label class="form-label small text-muted">开始日期</label>
                <input class="form-control" type="date" name="start_date" value="{{ current_start_date or '' }}">
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">结束日期</label>
                <input class="form-control" type="date" name="end_date" value="{{ current_end_date or '' }}">
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">课程选择</label>
                <select class="form-select" name="course_id">
                    <option value="">所有课程</option>
                    {% for c in courses %}
                    <option value="{{ c.course_id }}" {% if current_course_id == c.course_id %}selected{% endif %}>{{ c.course_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label small text-muted">学院</label>
                <select class="form-select" name="college">
                    <option value="">所有学院</option>
                    {% for c in colleges %}
                    <option value="{{ c }}" {% if current_college == c %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">姓名/学号</label>
                <input class="form-control" type="search" name="search_query" placeholder="输入姓名或学号" value="{{ current_search or '' }}">
            </div>
            <div class="col-12 d-flex gap-2">
                <button class="btn btn-primary" type="submit">查询</button>
                <a class="btn btn-outline-secondary" href="/history">重置</a>
            </div>
        </form>
    </div>
</div>

<div class="row g-3 mb-3">
    <div class="col-md-4">
        <div class="border rounded p-3 bg-white shadow-sm">
            <div class="text-muted small">查询结果总数</div>
            <div class="fs-4 fw-bold">{{ stats.total_count }}</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="border rounded p-3 bg-white shadow-sm">
            <div class="text-muted small">出勤率</div>
            <div class="fs-4 fw-bold">{{ stats.attendance_rate }}%</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="border rounded p-3 bg-white shadow-sm">
            <div class="text-muted small">平均置信度</div>
            <div class="fs-4 fw-bold">
                {% if stats.avg_confidence is not none %}
                {{ '%.3f'|format(stats.avg_confidence) }}
                {% else %}
                -
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="card shadow">
    <div class="card-body">
        <form id="attendanceDeleteForm" action="/api/delete_attendance" method="post">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 44px;">
                                <input class="form-check-input" type="checkbox" id="attendanceSelectAll">
                            </th>
                            <th style="width: 70px;">序号</th>
                            <th style="width: 140px;">学号</th>
                            <th style="width: 120px;">姓名</th>
                            <th style="width: 160px;">班级</th>
                            <th style="width: 180px;">课程</th>
                            <th style="width: 190px;">考勤时间</th>
                            <th style="width: 110px;">置信度</th>
                            <th style="width: 110px;">状态</th>
                            <th style="width: 110px;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for record in records %}
                        <tr>
                            <td>
                                <input class="form-check-input attendance-row" type="checkbox" name="ids" value="{{ record.record_id }}">
                            </td>
                            <td>{{ (page - 1) * page_size + loop.index }}</td>
                            <td>{{ record.student_id }}</td>
                            <td>{{ record.name }}</td>
                            <td>{{ record.class_name }}</td>
                            <td>{{ record.course_name }}</td>
                            <td>{{ record.timestamp }}</td>
                            <td>
                                {% if record.confidence is not none %}
                                {{ '%.3f'|format(record.confidence) }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td><span class="badge bg-success">{{ record.status }}</span></td>
                            <td>
                                <button
                                    class="btn btn-sm btn-outline-primary"
                                    type="button"
                                    data-bs-toggle="modal"
                                    data-bs-target="#attendanceDetailModal"
                                    data-record-id="{{ record.record_id }}"
                                    data-student-id="{{ record.student_id }}"
                                    data-name="{{ record.name }}"
                                    data-class-name="{{ record.class_name }}"
                                    data-course-name="{{ record.course_name }}"
                                    data-timestamp="{{ record.timestamp }}"
                                    data-confidence="{{ record.confidence }}"
                                    data-status="{{ record.status }}"
                                >详情</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>

        <div class="d-flex justify-content-between align-items-center">
            <div class="text-muted small">第 {{ page }} / {{ total_pages }} 页</div>
            <div class="btn-group">
                <a class="btn btn-outline-secondary btn-sm {% if page <= 1 %}disabled{% endif %}"
                   href="/history?page={{ page - 1 }}&page_size={{ page_size }}{% if current_course_id %}&course_id={{ current_course_id }}{% endif %}{% if current_college %}&college={{ current_college }}{% endif %}{% if current_search %}&search_query={{ current_search }}{% endif %}{% if current_start_date %}&start_date={{ current_start_date }}{% endif %}{% if current_end_date %}&end_date={{ current_end_date }}{% endif %}">上一页</a>
                <a class="btn btn-outline-secondary btn-sm {% if page >= total_pages %}disabled{% endif %}"
                   href="/history?page={{ page + 1 }}&page_size={{ page_size }}{% if current_course_id %}&course_id={{ current_course_id }}{% endif %}{% if current_college %}&college={{ current_college }}{% endif %}{% if current_search %}&search_query={{ current_search }}{% endif %}{% if current_start_date %}&start_date={{ current_start_date }}{% endif %}{% if current_end_date %}&end_date={{ current_end_date }}{% endif %}">下一页</a>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="attendanceDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">考勤详情</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-2">
            <div class="col-6">
                <div class="text-muted small">学号</div>
                <div class="fw-bold" id="detailStudentId">-</div>
            </div>
            <div class="col-6">
                <div class="text-muted small">姓名</div>
                <div class="fw-bold" id="detailName">-</div>
            </div>
            <div class="col-12">
                <div class="text-muted small">班级</div>
                <div class="fw-bold" id="detailClassName">-</div>
            </div>
            <div class="col-12">
                <div class="text-muted small">课程</div>
                <div class="fw-bold" id="detailCourseName">-</div>
            </div>
            <div class="col-12">
                <div class="text-muted small">考勤时间</div>
                <div class="fw-bold" id="detailTimestamp">-</div>
            </div>
            <div class="col-6">
                <div class="text-muted small">置信度</div>
                <div class="fw-bold" id="detailConfidence">-</div>
            </div>
            <div class="col-6">
                <div class="text-muted small">状态</div>
                <div class="fw-bold" id="detailStatus">-</div>
            </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const selectAll = document.getElementById('attendanceSelectAll');
    const rows = Array.from(document.querySelectorAll('input.attendance-row'));
    const form = document.getElementById('attendanceDeleteForm');

    const selectedIds = () => rows.filter(x => x.checked).map(x => x.value);

    if (selectAll) {
        selectAll.addEventListener('change', () => {
            rows.forEach(x => { x.checked = selectAll.checked; });
        });
    }
    rows.forEach(x => x.addEventListener('change', () => {
        if (!selectAll) return;
        const allChecked = rows.length > 0 && rows.every(y => y.checked);
        const noneChecked = rows.every(y => !y.checked);
        selectAll.indeterminate = !allChecked && !noneChecked;
        selectAll.checked = allChecked;
    }));

    if (form) {
        form.addEventListener('submit', (e) => {
            const ids = selectedIds();
            if (!ids.length) {
                e.preventDefault();
                alert('请先选择要删除的考勤记录');
                return;
            }
            if (!confirm(`确定删除选中的 ${ids.length} 条考勤记录吗？`)) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}
