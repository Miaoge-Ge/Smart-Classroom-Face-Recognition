{% extends "base.html" %}

{% block content %}
<h2>ğŸ‘¥ å­¦ç”Ÿç®¡ç†</h2>
<hr>

<!-- Register Form -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>æ–°å¢å­¦ç”Ÿ</span>
        <div>
            <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#importModal">
                ğŸ“‚ æ‰¹é‡å¯¼å…¥(Excel)
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#cameraModal">
                ğŸ“· æ‘„åƒå¤´æ‹ç…§æ³¨å†Œ
            </button>
        </div>
    </div>
    <div class="card-body">
        <form action="/api/register" method="post" enctype="multipart/form-data" class="row g-3" id="mainRegForm">
            <div class="col-md-3">
                <input type="text" class="form-control" name="name" id="mainName" placeholder="å§“å" required>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="student_id" id="mainId" placeholder="å­¦å·" required>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="gender" id="mainGender">
                    <option value="" selected disabled>æ€§åˆ«</option>
                    <option value="ç”·">ç”·</option>
                    <option value="å¥³">å¥³</option>
                </select>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" name="class_name" id="mainClass" placeholder="ç­çº§">
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" name="college" id="mainCollege" placeholder="å­¦é™¢">
            </div>
            <div class="col-md-10">
                <input type="file" class="form-control" name="file" id="mainFile" accept="image/*" required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">æ³¨å†Œ</button>
            </div>
        </form>
    </div>
</div>

<!-- Camera Modal -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">æ‘„åƒå¤´æ‹ç…§æ³¨å†Œ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <div style="position: relative; width: 640px; height: 480px; margin: 0 auto; background: #000;">
            <video id="regVideo" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
            <canvas id="regCanvas" width="640" height="480" style="display: none;"></canvas>
        </div>
        <div class="mt-3">
             <button id="snapBtn" class="btn btn-primary">ğŸ“¸ æ‹ç…§å¹¶å¡«å…¥</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">æ‰¹é‡å¯¼å…¥å­¦ç”Ÿ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="/api/import_students" method="post" enctype="multipart/form-data">
        <div class="modal-body">
            <p class="text-muted small">è¯·ä¸Šä¼ Excelæ–‡ä»¶ (.xlsx)ï¼ŒåŒ…å«ä»¥ä¸‹åˆ—ï¼šå§“å, å­¦å·, æ€§åˆ«, ç­çº§, å­¦é™¢</p>
            <div class="mb-3">
                <input class="form-control" type="file" name="file" accept=".xlsx, .xls" required>
            </div>
            <div class="mb-3">
                <a href="/static/template.xlsx" class="small" download>ä¸‹è½½æ¨¡æ¿æ–‡ä»¶</a>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary">å¼€å§‹å¯¼å…¥</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Student List -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span>å·²æ³¨å†Œå­¦ç”Ÿåˆ—è¡¨</span>
        <form class="d-flex" method="get" action="/students">
            <select class="form-select form-select-sm me-2" name="class_name" style="width: 150px;">
                <option value="">æ‰€æœ‰ç­çº§</option>
                {% for c in classes %}
                <option value="{{ c }}" {% if current_class == c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
            <button class="btn btn-sm btn-outline-secondary" type="submit">ç­›é€‰</button>
        </form>
    </div>
    <div class="card-body">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ç¼–å·</th>
                    <th>å§“å</th>
                    <th>å­¦å·</th>
                    <th>æ€§åˆ«</th>
                    <th>ç­çº§</th>
                    <th>å­¦é™¢</th>
                    <th>æ³¨å†Œæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr>
                    <td>{{ student.id }}</td>
                    <td>{{ student.name }}</td>
                    <td>{{ student.student_id or '-' }}</td>
                    <td>{{ student.gender or '-' }}</td>
                    <td>{{ student.class_name or '-' }}</td>
                    <td>{{ student.college or '-' }}</td>
                    <td>{{ student.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <form action="/api/delete_student" method="post" onsubmit="return confirm('ç¡®å®šåˆ é™¤å—?');">
                            <input type="hidden" name="student_id" value="{{ student.id }}">
                            <button type="submit" class="btn btn-sm btn-danger">åˆ é™¤</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const cameraModal = document.getElementById('cameraModal');
    const regVideo = document.getElementById('regVideo');
    const regCanvas = document.getElementById('regCanvas');
    const snapBtn = document.getElementById('snapBtn');
    let stream = null;

    cameraModal.addEventListener('shown.bs.modal', async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
            regVideo.srcObject = stream;
        } catch (err) {
            console.error(err);
            alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´");
        }
    });

    cameraModal.addEventListener('hidden.bs.modal', () => {
        if (stream) {
            stream.getTracks().forEach(t => t.stop());
            stream = null;
        }
    });

    snapBtn.addEventListener('click', () => {
        if (!stream) return;
        const ctx = regCanvas.getContext('2d');
        ctx.drawImage(regVideo, 0, 0, 640, 480);
        
        regCanvas.toBlob(blob => {
            // Create a File object
            const file = new File([blob], "capture.jpg", { type: "image/jpeg" });
            
            // Create a DataTransfer to populate the file input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            document.getElementById('mainFile').files = dataTransfer.files;
            
            // Close modal
            const modalInstance = bootstrap.Modal.getInstance(cameraModal);
            modalInstance.hide();
            
            alert("ç…§ç‰‡å·²æ•è·ï¼Œè¯·å®Œå–„å…¶ä»–ä¿¡æ¯åç‚¹å‡»æ³¨å†ŒæŒ‰é’®ã€‚");
        }, 'image/jpeg');
    });
});
</script>
{% endblock %}
