# 稳定性、并发与安全配置说明

## 并发与稳定性

- 后端 WebSocket 处理采用异步接收 + 线程池执行（解码/推理/写库），避免阻塞事件循环，支持多教室并发接入。
- SQLite 开启 WAL 与 busy_timeout，提升并发写入稳定性。
- 考勤写入采用 `event_key` 唯一约束实现去重，避免高并发/重启导致重复写入。

可在「系统设置」中在线调整：
- 去重时间窗口、采集分辨率、帧间隔、JPEG 质量
- 最大推理并发、最大 WebSocket 连接数

## 数据安全与隐私

### 1) 密码安全

- 用户密码使用 bcrypt 哈希存储，不保存明文。

### 2) 人脸数据加密存储

- 人脸图片以加密文件形式存储（默认 `data/faces/*.enc`）
- 人脸特征向量以加密形式存储在数据库字段 `students.face_embedding_enc`
- 加密密钥从以下位置读取（二选一）：
  - 环境变量：`FACE_DATA_KEY`
  - 本地文件：`secrets/face_data.key`（已被 `.gitignore` 忽略）

生成密钥：

```bash
python scripts/generate_face_data_key.py
```

将已存在的历史明文图片转换为加密文件（建议在生成密钥后执行，并重启服务）：

```bash
python scripts/encrypt_existing_faces.py
```

### 3) HTTPS / WSS

- 生产环境建议由 Nginx/网关终止 TLS，并通过 `X-Forwarded-Proto: https` 传递协议头。
- 在「系统设置」勾选“强制 HTTPS”后，系统会对 HTTP 请求做 307 跳转，并在 HTTPS 响应中添加 HSTS。

## 审计与追溯

- 系统会记录登录、登出、配置修改、导出、账号管理、学生与人脸相关操作等关键事件。
- 管理员可在「审计日志」页面查看最近 500 条记录。

